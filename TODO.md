# ccNexus 功能规划

本文件记录 ccNexus 项目的功能规划和待办事项。

## 高价值功能

### 1. 成本分析和预算管理
- [x] 按端点/模型的成本统计 - 根据各 API 提供商的定价计算实际花费
- [ ] 成本趋势图表 - 日/周/月成本变化可视化
- [ ] 预算告警 - 设置月度预算上限，接近时提醒
- [ ] 成本优化建议 - 分析哪些请求可以用更便宜的模型

### 2. 请求缓存
- [x] 精确缓存 - 完全相同请求直接返回
- [x] 缓存策略配置 - TTL、最大缓存大小
- [x] 缓存命中率统计 - 展示节省的 Token 和成本

### 3. 告警和通知
- [x] 端点故障告警 - 连续失败时通知（系统通知）
- [x] 性能异常告警 - 响应时间突然变慢
- [ ] 配额告警 - 接近 API 限额时提醒

### 4. 请求重放和调试
- [ ] 保存请求 - 将特定请求保存为模板
- [ ] 重放请求 - 一键重新发送历史请求
- [ ] 请求对比 - 对比不同端点的响应差异
- [ ] 调试模式 - 详细记录请求/响应内容

### 5. API 限流和配额
- [x] 全局速率限制 - 每分钟最大请求数
- [x] 按端点限流 - 防止单个端点过载
- [ ] Token 配额 - 每日/每月 Token 上限
- [ ] 排队机制 - 超限请求排队等待

---

## 快速实现的小功能

### 6. 端点分组/标签
- [x] 给端点添加标签（如：生产、测试、备用）
- [x] 按标签筛选和管理端点

### 7. 端点健康历史
- [x] 记录端点健康状态变化历史
- [x] 可视化展示可用性趋势

---

## 代码中的 TODO

以下是代码中已存在的 TODO 注释：

### macOS 菜单更新
- [x] `internal/tray/tray_darwin.go` - 实现原生菜单更新和多语言支持

### Linux 托盘支持
- [x] `internal/tray/tray_linux.go` - 使用 energye/systray 库实现 Linux 托盘支持

### OpenAI Responses API 兼容性
- [x] `internal/transformer/convert/claude_openai2.go:51` - max_output_tokens 参数兼容性处理
- [x] `internal/transformer/convert/openai_openai2.go:48` - max_output_tokens 参数兼容性处理

---

## 已完成功能

### 成本统计 ✅
- [x] 按端点/模型的成本统计
- [x] 支持 Claude、OpenAI、Gemini 等主流 API 定价
- [x] 区分输入/输出/缓存写入/缓存读取 Token 成本

### 请求缓存 ✅
- [x] 精确请求缓存（基于请求内容哈希）
- [x] 可配置 TTL 和最大缓存条目数
- [x] 缓存命中/未命中统计
- [x] 支持手动清空缓存

### 速率限制 ✅
- [x] 全局每分钟最大请求数限制
- [x] 每端点每分钟最大请求数限制
- [x] 超限返回 429 状态码和 Retry-After 头
- [x] 速率限制统计（允许/拒绝次数）

### 性能异常告警 ✅
- [x] 延迟阈值告警（超过指定毫秒数触发）
- [x] 延迟增加比例告警（相比平均值增加超过指定百分比触发）
- [x] 可配置告警冷却时间

### 一键检测和端点优化 ✅
- [x] 并发测试所有端点（包括禁用的）
- [x] 自动将延迟最低的端点设为当前使用
- [x] 自动启用检测成功的端点，禁用检测失败的端点
- [x] 实时监控面板显示每个端点的检测时间和结果

### 导入/导出端点配置 ✅
- [x] 导出端点配置为 JSON（支持导出当前客户端或全部端点）
- [x] 从文件批量导入端点（支持跳过/覆盖/重命名三种模式）
- [x] 支持拖拽文件导入
- [x] 可选是否包含 API 密钥

### 请求超时配置 ✅
- [x] 可配置的请求超时时间（1-30分钟）
- [x] 在设置页面中配置

### 快捷键支持 ✅
- [x] `Ctrl/Cmd+N` - 添加端点
- [x] `Ctrl/Cmd+,` - 打开设置
- [x] `Ctrl/Cmd+R` - 刷新端点
- [x] `Ctrl/Cmd+L` - 切换日志面板
- [x] `Ctrl/Cmd+E` - 切换端点面板
- [x] `Ctrl/Cmd+W` - 隐藏窗口
- [x] `Escape` - 关闭弹窗

### 深色/浅色模式跟随系统 ✅
- [x] 自动主题支持两种模式：按时间切换、跟随系统
- [x] 跟随系统模式实时响应系统主题变化

### 系统托盘多语言支持 ✅
- [x] macOS 原生托盘菜单多语言支持（显示窗口、退出）
- [x] Linux 系统托盘支持（使用 energye/systray 库）
- [x] Windows 系统托盘支持
- [x] 托盘菜单语言动态切换

### 端点三状态系统 ✅
- [x] 端点状态从二元升级为三状态（可用/不可用/禁用）
- [x] 健康检查自动在可用/不可用状态间切换
- [x] 只从可用状态的端点中选择请求
- [x] 数据库自动迁移，完全向后兼容
- [x] 前端实时显示端点状态（彩色圆点图标）
- [x] 会话亲和性验证端点必须为可用状态
- [x] 相同优先级端点随机选择实现负载均衡

### 智能路由策略 ✅
- [x] 基于模型的路由 - 不同模型请求路由到不同端点
- [x] 基于负载均衡 - 根据端点响应时间动态分配
- [x] 基于成本优先 - 优先使用更便宜的端点
- [x] 基于配额 - 端点配额用尽自动切换
- [x] 优先级路由 - 按优先级选择，相同优先级随机分配

---

*最后更新: 2026-01-17*
