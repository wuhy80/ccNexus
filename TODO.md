# ccNexus 功能规划

本文件记录 ccNexus 项目的功能规划和待办事项。

## 高价值功能

### 1. 成本分析和预算管理
- [x] 按端点/模型的成本统计 - 根据各 API 提供商的定价计算实际花费
- [ ] 成本趋势图表 - 日/周/月成本变化可视化
- [ ] 预算告警 - 设置月度预算上限，接近时提醒
- [ ] 成本优化建议 - 分析哪些请求可以用更便宜的模型

### 2. 智能路由策略
- [ ] 基于模型的路由 - 不同模型请求路由到不同端点
- [ ] 基于负载均衡 - 根据端点响应时间动态分配
- [ ] 基于成本优先 - 优先使用更便宜的端点
- [ ] 基于配额 - 端点配额用尽自动切换

### 3. 请求缓存
- [ ] 语义缓存 - 相似请求返回缓存结果
- [x] 精确缓存 - 完全相同请求直接返回
- [x] 缓存策略配置 - TTL、最大缓存大小
- [x] 缓存命中率统计 - 展示节省的 Token 和成本

### 4. 告警和通知
- [x] 端点故障告警 - 连续失败时通知（系统通知）
- [x] 性能异常告警 - 响应时间突然变慢
- [ ] 配额告警 - 接近 API 限额时提醒
- [ ] 通知渠道 - Webhook、邮件

### 5. 请求重放和调试
- [ ] 保存请求 - 将特定请求保存为模板
- [ ] 重放请求 - 一键重新发送历史请求
- [ ] 请求对比 - 对比不同端点的响应差异
- [ ] 调试模式 - 详细记录请求/响应内容

### 6. API 限流和配额
- [x] 全局速率限制 - 每分钟最大请求数
- [x] 按端点限流 - 防止单个端点过载
- [ ] Token 配额 - 每日/每月 Token 上限
- [ ] 排队机制 - 超限请求排队等待

### 7. Prometheus/Grafana 集成
- [ ] Metrics 端点 - 导出 Prometheus 格式指标
- [ ] 预置 Dashboard - Grafana 仪表板模板
- [ ] 自定义指标 - 支持添加业务指标

### 8. 多用户/团队支持
- [ ] API Key 管理 - 为不同用户生成独立 Key
- [ ] 用户级统计 - 按用户统计使用量
- [ ] 权限控制 - 限制用户可用的端点/模型
- [ ] 审计日志 - 记录所有操作

---

## 快速实现的小功能

### 9. 端点分组/标签
- [x] 给端点添加标签（如：生产、测试、备用）
- [x] 按标签筛选和管理端点

### 10. 端点健康历史
- [x] 记录端点健康状态变化历史
- [x] 可视化展示可用性趋势

---

## 代码中的 TODO

以下是代码中已存在的 TODO 注释：

### macOS 菜单更新
- [ ] `internal/tray/tray_darwin.go:57` - Implement native menu update for macOS

### Linux 托盘支持
- [ ] `internal/tray/tray_other.go:7` - Implement for Linux using appropriate libraries

### OpenAI Responses API 兼容性
- [x] `internal/transformer/convert/claude_openai2.go:51` - max_output_tokens 参数兼容性处理
- [x] `internal/transformer/convert/openai_openai2.go:48` - max_output_tokens 参数兼容性处理

---

## 已完成功能

### 成本统计 ✅
- [x] 按端点/模型的成本统计
- [x] 支持 Claude、OpenAI、Gemini 等主流 API 定价
- [x] 区分输入/输出/缓存写入/缓存读取 Token 成本

### 请求缓存 ✅
- [x] 精确请求缓存（基于请求内容哈希）
- [x] 可配置 TTL 和最大缓存条目数
- [x] 缓存命中/未命中统计
- [x] 支持手动清空缓存

### 速率限制 ✅
- [x] 全局每分钟最大请求数限制
- [x] 每端点每分钟最大请求数限制
- [x] 超限返回 429 状态码和 Retry-After 头
- [x] 速率限制统计（允许/拒绝次数）

### 性能异常告警 ✅
- [x] 延迟阈值告警（超过指定毫秒数触发）
- [x] 延迟增加比例告警（相比平均值增加超过指定百分比触发）
- [x] 可配置告警冷却时间

### 导入/导出端点配置 ✅
- [x] 导出端点配置为 JSON（支持导出当前客户端或全部端点）
- [x] 从文件批量导入端点（支持跳过/覆盖/重命名三种模式）
- [x] 支持拖拽文件导入
- [x] 可选是否包含 API 密钥

### 请求超时配置 ✅
- [x] 可配置的请求超时时间（1-30分钟）
- [x] 在设置页面中配置

### 快捷键支持 ✅
- [x] `Ctrl/Cmd+N` - 添加端点
- [x] `Ctrl/Cmd+,` - 打开设置
- [x] `Ctrl/Cmd+R` - 刷新端点
- [x] `Ctrl/Cmd+L` - 切换日志面板
- [x] `Ctrl/Cmd+E` - 切换端点面板
- [x] `Ctrl/Cmd+W` - 隐藏窗口
- [x] `Escape` - 关闭弹窗

### 深色/浅色模式跟随系统 ✅
- [x] 自动主题支持两种模式：按时间切换、跟随系统
- [x] 跟随系统模式实时响应系统主题变化

---

*最后更新: 2026-01-16*
