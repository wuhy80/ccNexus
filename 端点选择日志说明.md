# 端点选择日志说明

## 概述

现在系统已经增强了端点选择过程的日志输出，你可以清楚地看到每次请求时端点是如何被选择的。

## 日志内容

当有新的请求到来时，你会在日志中看到以下信息：

### 1. 初始可用端点
```
[路由选择] 初始可用端点: 共3个 [端点A 端点B 端点C] 优先级: [1 2 3]
```
显示所有可用状态的端点及其优先级。

### 2. 模型匹配过滤（如果启用）
```
[路由选择] 模型匹配过滤 (模型=claude-3-5-sonnet-20241022): 3个 → 2个
[路由选择] 剩余端点: [端点A 端点B]
```
显示根据模型模式过滤后剩余的端点。

### 3. 配额过滤（如果启用）
```
[路由选择] 配额过滤: 2个 → 2个
[路由选择] 剩余端点: [端点A 端点B]
```
显示过滤掉配额用尽的端点后的结果。

### 4. 选择方法和最终结果
```
[路由选择] 选择方法: 优先级
[路由选择] ✅ 最终选择: 端点A (优先级=1)
[路由选择] 候选端点详情:
[路由选择]   ✅ 端点A (优先级=1, 成本=0.000015)
[路由选择]     端点B (优先级=2, 成本=0.000020)
```
显示使用的选择方法、最终选择的端点，以及所有候选端点的详细信息。

### 5. 优先级选择的详细过程（DEBUG级别）
```
[路由选择] 最高优先级=1, 该优先级端点数=2
[路由选择] 相同优先级端点: [端点A 端点C], 随机选择索引=0
```
当有多个相同优先级的端点时，显示随机选择的过程。

## 如何查看日志

### 方法1：应用内日志查看器
1. 打开 ccNexus 桌面应用
2. 点击左侧菜单的"日志"
3. 在日志列表中查找带有 `[路由选择]` 标记的条目

### 方法2：控制台输出
如果你从命令行启动应用，这些日志会直接输出到控制台。

### 方法3：调试日志文件
如果启用了调试模式，日志会写入到 `debug.log` 文件中。

## 选择策略说明

系统支持以下几种端点选择策略：

### 1. 优先级选择（默认）
- 选择优先级数字最小的端点
- 如果有多个相同优先级的端点，随机选择一个
- 日志显示：`选择方法: 优先级`

### 2. 成本优先
- 选择成本最低的端点（输入成本+输出成本）
- 日志显示：`选择方法: 成本优先`

### 3. 负载均衡
根据配置的算法：
- **轮询 (round_robin)**：依次使用每个端点
- **最快响应 (fastest)**：选择平均响应时间最短的端点
- **加权随机 (weighted)**：响应时间越短的端点被选中概率越高
- 日志显示：`选择方法: 负载均衡-round_robin` 等

## 配置路由策略

在应用的"设置"中可以配置：
- 启用模型路由：根据请求的模型匹配端点的模型模式
- 启用配额路由：自动排除配额用尽的端点
- 启用成本优先：优先选择成本低的端点
- 启用负载均衡：根据负载情况分配请求

## 示例场景

### 场景1：按优先级选择
配置：
- 端点A：优先级=1
- 端点B：优先级=2
- 端点C：优先级=3

日志输出：
```
[路由选择] 初始可用端点: 共3个 [端点A 端点B 端点C] 优先级: [1 2 3]
[路由选择] 选择方法: 优先级
[路由选择] ✅ 最终选择: 端点A (优先级=1)
```

### 场景2：相同优先级随机选择
配置：
- 端点A：优先级=1
- 端点B：优先级=1
- 端点C：优先级=2

日志输出：
```
[路由选择] 初始可用端点: 共3个 [端点A 端点B 端点C] 优先级: [1 1 2]
[路由选择] 选择方法: 优先级
🔍 [DEBUG] [路由选择] 最高优先级=1, 该优先级端点数=2
🔍 [DEBUG] [路由选择] 相同优先级端点: [端点A 端点B], 随机选择索引=0
[路由选择] ✅ 最终选择: 端点A (优先级=1)
```

### 场景3：模型匹配过滤
配置：
- 端点A：模型模式="claude-*", 优先级=1
- 端点B：模型模式="gpt-*", 优先级=1
- 请求模型：claude-3-5-sonnet-20241022

日志输出：
```
[路由选择] 初始可用端点: 共2个 [端点A 端点B] 优先级: [1 1]
[路由选择] 模型匹配过滤 (模型=claude-3-5-sonnet-20241022): 2个 → 1个
[路由选择] 剩余端点: [端点A]
[路由选择] 选择方法: 优先级
[路由选择] ✅ 最终选择: 端点A (优先级=1)
```

## 注意事项

1. **INFO 级别日志**：主要的选择过程日志使用 INFO 级别，默认会显示
2. **DEBUG 级别日志**：详细的内部决策过程使用 DEBUG 级别，需要在设置中启用 DEBUG 日志级别才能看到
3. **日志标记**：所有路由选择相关的日志都带有 `[路由选择]` 前缀，方便过滤查找
4. **实时性**：日志会在每次请求时实时生成，你可以看到每个请求的选择过程

## 故障排查

如果你发现端点选择不符合预期：

1. 检查日志中的"初始可用端点"，确认哪些端点是可用状态
2. 查看过滤步骤，了解哪些端点被过滤掉了
3. 检查"候选端点详情"，确认优先级和成本配置是否正确
4. 如果有多个相同优先级的端点，注意它们是随机选择的

## 更新日志

- 2026-01-17: 添加详细的端点选择日志输出
  - 显示初始可用端点列表和优先级
  - 显示每个过滤步骤的结果
  - 显示最终选择的端点和选择方法
  - 显示所有候选端点的详细信息
