# 端点优先级选择修复说明

## 问题描述

**原始问题：** 系统没有按照设置的优先级选择端点。

**根本原因：** 优先级选择功能被错误地绑定到"智能路由"开关上。只有在设置中启用了至少一个路由策略（模型路由、负载均衡、成本优先、配额路由）时，系统才会使用优先级选择。如果所有路由策略都关闭（默认状态），系统会使用传统的轮询逻辑，完全忽略优先级设置。

## 修复方案

### 修改文件
`internal/proxy/proxy.go` - `selectEndpointForRequest` 函数

### 修改内容

**修改前的逻辑：**
```
1. 检查会话亲和性
2. 如果启用了路由策略 → 使用智能路由（包括优先级）
3. 否则 → 使用轮询逻辑（忽略优先级）❌
```

**修改后的逻辑：**
```
1. 检查会话亲和性
2. 如果启用了高级路由策略 → 使用智能路由（模型/负载/成本/配额）
3. 否则 → 使用优先级选择（默认行为）✅
4. 最后回退 → 轮询逻辑（仅当优先级选择失败时）
```

### 关键改进

#### 1. 优先级选择现在是默认行为
```go
// 3. 回退到优先级选择（默认行为）
// 即使没有启用高级路由策略，也应该按优先级选择端点
if p.router != nil {
    endpoint, err := p.router.selectByPriority(p.config.GetAvailableEndpointsByClient(string(clientType)))
    if err == nil {
        logger.Debug("[PRIORITY:%s] Selected endpoint: %s", clientType, endpoint.Name)
        selectedEndpoint = endpoint
        // ... 绑定会话
        return selectedEndpoint
    }
    logger.Warn("[PRIORITY:%s] Selection failed: %v, falling back to round-robin", clientType, err)
}
```

#### 2. 轮询逻辑作为最后的回退
```go
// 4. 最后回退到传统轮询逻辑（仅当优先级选择也失败时）
selectedEndpoint = p.getCurrentEndpointForClient(clientType)
```

#### 3. 增强的日志输出
- `[PRIORITY:%s]` - 优先级选择日志
- `[ROUTER:%s]` - 智能路由日志
- `[SESSION:%s]` - 会话亲和性日志

## 端点选择流程

### 完整的选择流程

```
新请求到达
    ↓
1. 检查会话亲和性
   ├─ 有绑定且端点可用 → 使用绑定的端点 ✅
   └─ 无绑定或端点不可用 → 继续
    ↓
2. 检查高级路由策略
   ├─ 启用了模型路由/负载均衡/成本优先/配额路由
   │  └─ 使用智能路由选择 ✅
   └─ 未启用任何高级策略 → 继续
    ↓
3. 使用优先级选择（默认）
   ├─ 选择优先级最高的端点
   │  └─ 相同优先级随机选择 ✅
   └─ 选择失败 → 继续
    ↓
4. 轮询逻辑（最后回退）
   └─ 依次使用每个端点 ✅
```

### 优先级选择规则

1. **按优先级数字排序**：数字越小，优先级越高
   - 优先级 1 > 优先级 2 > 优先级 3

2. **相同优先级随机选择**：
   - 如果有多个端点优先级相同，随机选择一个
   - 避免总是使用同一个端点

3. **只选择可用端点**：
   - 只从状态为 `available` 的端点中选择
   - 自动排除 `unavailable` 和 `disabled` 状态的端点

## 使用场景

### 场景 1：默认使用（推荐）
**配置：**
- 不启用任何路由策略
- 只设置端点的优先级

**行为：**
- 系统自动按优先级选择端点
- 优先级 1 的端点优先使用
- 相同优先级的端点随机选择

**日志示例：**
```
ℹ️ [INFO] [路由选择] 初始可用端点: 共3个 [端点A 端点B 端点C] 优先级: [1 2 3]
ℹ️ [INFO] [路由选择] 选择方法: 优先级
ℹ️ [INFO] [路由选择] ✅ 最终选择: 端点A (优先级=1)
🔍 [DEBUG] [PRIORITY:claude] Selected endpoint: 端点A
```

### 场景 2：启用高级路由
**配置：**
- 启用模型路由/负载均衡/成本优先/配额路由
- 设置端点的优先级

**行为：**
- 先应用高级路由策略（过滤、排序）
- 在符合条件的端点中按优先级选择

**日志示例：**
```
ℹ️ [INFO] [路由选择] 初始可用端点: 共3个 [端点A 端点B 端点C] 优先级: [1 2 3]
ℹ️ [INFO] [路由选择] 模型匹配过滤 (模型=claude-3-5-sonnet): 3个 → 2个
ℹ️ [INFO] [路由选择] 剩余端点: [端点A 端点B]
ℹ️ [INFO] [路由选择] 选择方法: 优先级
ℹ️ [INFO] [路由选择] ✅ 最终选择: 端点A (优先级=1)
🔍 [DEBUG] [ROUTER:claude] Selected endpoint: 端点A (model: claude-3-5-sonnet)
```

### 场景 3：会话亲和性
**配置：**
- 启用会话亲和性
- 设置端点的优先级

**行为：**
- 首次请求按优先级选择端点
- 后续请求使用相同的端点（会话绑定）
- 会话超时后重新按优先级选择

**日志示例：**
```
# 首次请求
🔍 [DEBUG] [PRIORITY:claude] Selected endpoint: 端点A
🔍 [DEBUG] [SESSION:abc123] Bound to priority endpoint: 端点A

# 后续请求
🔍 [DEBUG] [SESSION:abc123] Using bound endpoint: 端点A
```

## 验证方法

### 1. 查看日志
启动应用后，在日志中查找 `[路由选择]` 或 `[PRIORITY]` 标记：

```bash
# 启动应用
cd cmd/desktop
wails dev

# 发起请求后查看日志
# 应该看到类似这样的输出：
ℹ️ [INFO] [路由选择] 初始可用端点: 共3个 [端点A 端点B 端点C] 优先级: [1 2 3]
ℹ️ [INFO] [路由选择] 选择方法: 优先级
ℹ️ [INFO] [路由选择] ✅ 最终选择: 端点A (优先级=1)
```

### 2. 测试优先级
**步骤：**
1. 配置 3 个端点，优先级分别为 1、2、3
2. 确保所有端点都是可用状态
3. 不启用任何路由策略
4. 发起多个请求
5. 观察日志，应该总是选择优先级 1 的端点

### 3. 测试相同优先级
**步骤：**
1. 配置 3 个端点，优先级都设为 1
2. 发起多个请求
3. 观察日志，应该看到随机选择不同的端点

### 4. 测试回退逻辑
**步骤：**
1. 禁用所有端点
2. 发起请求
3. 应该看到错误信息："No enabled endpoints available"

## 兼容性说明

### 向后兼容
- ✅ 现有配置无需修改
- ✅ 已启用路由策略的用户不受影响
- ✅ 未启用路由策略的用户现在会自动使用优先级选择

### 升级影响
**升级前：**
- 未启用路由策略 → 使用轮询逻辑（忽略优先级）

**升级后：**
- 未启用路由策略 → 使用优先级选择（尊重优先级设置）✅

这是一个**行为改进**，不是破坏性变更。用户会发现系统现在按照他们设置的优先级工作了。

## 相关文件

- `internal/proxy/proxy.go` - 端点选择逻辑（已修改）
- `internal/proxy/router.go` - 路由器和优先级选择（已添加日志）
- `internal/config/routing.go` - 路由配置定义（未修改）

## 更新日志

- 2026-01-17: 修复优先级选择逻辑
  - 优先级选择现在是默认行为，不需要启用路由策略
  - 添加详细的日志输出，显示选择过程
  - 轮询逻辑作为最后的回退机制
  - 增强会话亲和性与优先级选择的集成

## 常见问题

### Q: 为什么我的端点没有按优先级选择？
A: 请检查：
1. 端点是否处于"可用"状态（绿色圆点）
2. 查看日志中的 `[路由选择]` 信息
3. 确认优先级数字设置正确（数字越小优先级越高）

### Q: 如何禁用优先级选择，使用轮询？
A: 目前无法禁用优先级选择。如果需要轮询效果，可以将所有端点设置为相同的优先级。

### Q: 会话亲和性和优先级选择如何配合？
A:
- 首次请求：按优先级选择端点
- 后续请求：使用相同的端点（会话绑定）
- 会话超时：重新按优先级选择

### Q: 启用路由策略后，优先级还有效吗？
A: 有效。路由策略会先过滤/排序端点，然后在符合条件的端点中按优先级选择。
