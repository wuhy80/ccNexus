# Token ç»Ÿè®¡ç³»ç»Ÿæ”¹è¿› - å®æ–½æ€»ç»“

## âœ… å·²å®Œæˆçš„ä¿®æ”¹ï¼ˆ8/8 æ­¥éª¤ï¼‰

### 1. æ•°æ®åº“å±‚ âœ…
**æ–‡ä»¶ï¼š** `internal/storage/interface.go`, `internal/storage/sqlite.go`

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ·»åŠ  `cache_creation_tokens` å’Œ `cache_read_tokens` åˆ—åˆ° `daily_stats` è¡¨
- âœ… åˆ›å»º `request_stats` è¡¨ç”¨äºè¯·æ±‚çº§åˆ«ç»Ÿè®¡
- âœ… å®ç° `migrateCacheTokens()` å’Œ `migrateRequestStats()` è‡ªåŠ¨è¿ç§»
- âœ… æ–°å¢æ–¹æ³•ï¼š
  - `RecordRequestStat()` - è®°å½•å•æ¬¡è¯·æ±‚ç»Ÿè®¡
  - `GetRequestStats()` - æŸ¥è¯¢è¯·æ±‚ç»Ÿè®¡ï¼ˆåˆ†é¡µï¼‰
  - `GetRequestStatsCount()` - è·å–è¯·æ±‚ç»Ÿè®¡æ€»æ•°
  - `CleanupOldRequestStats()` - æ¸…ç†æ—§æ•°æ®
- âœ… æ›´æ–°æ‰€æœ‰æŸ¥è¯¢æ–¹æ³•ä»¥åŒ…å« cache token å­—æ®µ
- âœ… æ›´æ–°å¤‡ä»½æ¢å¤é€»è¾‘ä»¥æ”¯æŒæ–°å­—æ®µ

### 2. Transformer å±‚ âœ…
**æ–‡ä»¶ï¼š** `internal/transformer/types.go`

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ–°å¢ `TokenUsageDetail` ç»“æ„ä½“ï¼š
  ```go
  type TokenUsageDetail struct {
      InputTokens              int
      CacheCreationInputTokens int
      CacheReadInputTokens     int
      OutputTokens             int
  }
  ```
- âœ… æ–°å¢ `ExtractTokenUsageDetail()` å‡½æ•°æå–è¯¦ç»† token åˆ†ç±»
- âœ… ä¿ç•™ `ExtractInputTokens()` å‘åå…¼å®¹

### 3. ç»Ÿè®¡è®°å½•å±‚ âœ…
**æ–‡ä»¶ï¼š** `internal/proxy/stats.go`

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ›´æ–°æ‰€æœ‰ç»Ÿè®¡ç»“æ„ä½“æ·»åŠ  cache token å­—æ®µ
- âœ… ä¿®æ”¹ `RecordTokens()` æ¥æ”¶ `TokenUsageDetail` å‚æ•°
- âœ… æ–°å¢ `RecordRequestStat()` è®°å½•è¯·æ±‚çº§åˆ«ç»Ÿè®¡
- âœ… æ–°å¢ `GetStorage()` æ–¹æ³•ç”¨äºæ¸…ç†æ“ä½œ
- âœ… æ›´æ–°æŸ¥è¯¢æ–¹æ³•ä»¥æ”¯æŒ cache tokens

### 4. å­˜å‚¨é€‚é…å™¨ âœ…
**æ–‡ä»¶ï¼š** `internal/storage/stats_adapter.go`

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ›´æ–° `RecordDailyStat()` æå– cache token å­—æ®µ
- âœ… æ–°å¢ `RecordRequestStat()` æ–¹æ³•
- âœ… æ›´æ–°æ‰€æœ‰å…¼å®¹ç»“æ„ä½“ï¼ˆ`StatsDataCompat`, `DailyRecordCompat`ï¼‰

### 5. Proxy å“åº”å¤„ç†å±‚ âœ…
**æ–‡ä»¶ï¼š** `internal/proxy/response.go`, `internal/proxy/streaming.go`

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… `response.go`:
  - ä¿®æ”¹ `handleNonStreamingResponse()` è¿”å› `TokenUsageDetail`
  - ä¿®æ”¹ `extractTokenUsage()` æå–è¯¦ç»† token ä¿¡æ¯

- âœ… `streaming.go`:
  - ä¿®æ”¹ `handleStreamingResponse()` è¿”å› `TokenUsageDetail`
  - ä¿®æ”¹ `extractTokensFromEvent()` æå–è¯¦ç»† token ä¿¡æ¯

### 6. Proxy ä¸»å¤„ç†å™¨ âœ…
**æ–‡ä»¶ï¼š** `internal/proxy/proxy.go`

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ›´æ–°æµå¼å“åº”å¤„ç†ï¼š
  - ä½¿ç”¨ `TokenUsageDetail` æ¥æ”¶è¿”å›å€¼
  - è®°å½•æ¯æ—¥èšåˆç»Ÿè®¡
  - è®°å½•è¯·æ±‚çº§åˆ«ç»Ÿè®¡ï¼ˆåŒ…å«æ¨¡å‹åã€æ—¶é—´æˆ³ç­‰ï¼‰

- âœ… æ›´æ–°éæµå¼å“åº”å¤„ç†ï¼š
  - ä½¿ç”¨ `TokenUsageDetail` æ¥æ”¶è¿”å›å€¼
  - ä»è¯·æ±‚ä½“æå–æ¨¡å‹å
  - è®°å½•ä¸¤å±‚ç»Ÿè®¡æ•°æ®

### 7. Service å±‚ âœ…
**æ–‡ä»¶ï¼š** `internal/service/stats.go`

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ›´æ–° `getPeriodStats()` èšåˆ cache token å­—æ®µ
- âœ… åœ¨è¿”å›çš„ JSON ä¸­åŒ…å«ï¼š
  - `totalCacheCreationTokens`
  - `totalCacheReadTokens`

### 8. æ•°æ®ç»“æ„å®Œæ•´æ€§ âœ…
æ‰€æœ‰ç›¸å…³ç»“æ„ä½“å·²æ›´æ–°ä»¥æ”¯æŒä¸‰åˆ†ç±» tokenï¼š
- `DailyStat` - æ•°æ®åº“è®°å½•
- `DailyStats` - Proxy å±‚ç»Ÿè®¡
- `EndpointStats` - ç«¯ç‚¹ç»Ÿè®¡
- `StatRecord` - ç»Ÿè®¡è®°å½•
- `RequestStatRecord` - è¯·æ±‚ç»Ÿè®¡è®°å½•
- `StatsData` - èšåˆæ•°æ®
- `DailyRecord` - æ¯æ—¥è®°å½•

---

## ğŸ“Š æ–°åŠŸèƒ½ç‰¹æ€§

### 1. ä¸‰åˆ†ç±» Token ç»Ÿè®¡
- **æ ‡å‡†è¾“å…¥ token** (`input_tokens`)
- **ç¼“å­˜åˆ›å»º token** (`cache_creation_tokens`) - å†™å…¥ç¼“å­˜çš„æˆæœ¬
- **ç¼“å­˜è¯»å– token** (`cache_read_tokens`) - ä»ç¼“å­˜è¯»å–çš„æˆæœ¬

### 2. åŒå±‚ç»Ÿè®¡æ¶æ„
- **æ¯æ—¥èšåˆç»Ÿè®¡** (`daily_stats` è¡¨)
  - æŒ‰ç«¯ç‚¹ã€æ—¥æœŸã€è®¾å¤‡èšåˆ
  - é•¿æœŸä¿å­˜
  - ç”¨äºè¶‹åŠ¿åˆ†æ

- **è¯·æ±‚çº§åˆ«ç»Ÿè®¡** (`request_stats` è¡¨)
  - è®°å½•æ¯æ¬¡è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
  - åŒ…å«ï¼šç«¯ç‚¹ã€æ¨¡å‹ã€æ—¶é—´æˆ³ã€token è¯¦æƒ…ã€æ˜¯å¦æµå¼
  - é»˜è®¤ä¿ç•™ 90 å¤©ï¼ˆå¯é…ç½®ï¼‰
  - æ”¯æŒåˆ†é¡µæŸ¥è¯¢

### 3. è‡ªåŠ¨æ•°æ®åº“è¿ç§»
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶æ·»åŠ æ–°å­—æ®µ
- å†å²æ•°æ®ä¿æŒä¸å˜ï¼ˆæ–°å­—æ®µé»˜è®¤ä¸º 0ï¼‰
- å¹‚ç­‰æ€§è®¾è®¡ï¼Œå¯é‡å¤æ‰§è¡Œ

### 4. å‘åå…¼å®¹
- ä¿ç•™æ—§çš„ `ExtractInputTokens()` å‡½æ•°
- å†å²ç»Ÿè®¡æ•°æ®ä¸å—å½±å“
- API å“åº”æ ¼å¼æ‰©å±•ä½†ä¸ç ´åç°æœ‰å­—æ®µ

---

## ğŸ”§ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. ç¼–è¯‘æµ‹è¯•
```bash
cd cmd/desktop
go build
```

### 2. è¿è¡Œæµ‹è¯•
```bash
# å¯åŠ¨åº”ç”¨
./ccNexus.exe  # Windows
./ccNexus      # macOS/Linux

# å‘é€æµ‹è¯•è¯·æ±‚
curl -X POST http://localhost:3003/v1/messages \
  -H "Content-Type: application/json" \
  -H "x-api-key: your-key" \
  -d '{"model":"claude-3-5-sonnet-20241022","max_tokens":100,"messages":[{"role":"user","content":"Hello"}]}'
```

### 3. éªŒè¯æ•°æ®
```bash
# æŸ¥çœ‹æ•°æ®åº“
sqlite3 ~/.ccNexus/ccnexus.db

# æ£€æŸ¥ daily_stats è¡¨ç»“æ„
.schema daily_stats

# æ£€æŸ¥ request_stats è¡¨
.schema request_stats

# æŸ¥è¯¢ç»Ÿè®¡æ•°æ®
SELECT * FROM daily_stats ORDER BY date DESC LIMIT 5;
SELECT * FROM request_stats ORDER BY timestamp DESC LIMIT 5;
```

### 4. UI æ›´æ–°ï¼ˆå¯é€‰ï¼‰
å¦‚éœ€åœ¨ UI ä¸­å±•ç¤º cache token ä¿¡æ¯ï¼Œéœ€è¦ä¿®æ”¹ï¼š
- æ¡Œé¢ç‰ˆï¼š`cmd/desktop/frontend/` ä¸‹çš„ Vue ç»„ä»¶
- æœåŠ¡å™¨ç‰ˆï¼šç›¸åº”çš„ Web UI æ–‡ä»¶

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“å¤‡ä»½**
   - é¦–æ¬¡è¿è¡Œå‰å»ºè®®å¤‡ä»½æ•°æ®åº“
   - ä½ç½®ï¼š`~/.ccNexus/ccnexus.db`

2. **è¯·æ±‚ç»Ÿè®¡æ¸…ç†**
   - é»˜è®¤ä¿ç•™ 90 å¤©
   - å¯é€šè¿‡ `CleanupOldRequestStats(daysToKeep)` è°ƒæ•´
   - å»ºè®®è®¾ç½®å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ¸…ç†

3. **æ€§èƒ½è€ƒè™‘**
   - è¯·æ±‚ç»Ÿè®¡è¡¨ä¼šå¿«é€Ÿå¢é•¿
   - å»ºè®®å®šæœŸç›‘æ§æ•°æ®åº“å¤§å°
   - é«˜å¹¶å‘åœºæ™¯å¯èƒ½éœ€è¦ä¼˜åŒ–å†™å…¥æ€§èƒ½

4. **Cache Token æ”¯æŒ**
   - ä»… Claude API è¿”å› cache token ä¿¡æ¯
   - OpenAIã€Gemini ç­‰ API çš„ cache token å­—æ®µå°†ä¸º 0
   - è½¬æ¢è¿‡ç¨‹ä¸­ cache ä¿¡æ¯å¯èƒ½ä¸¢å¤±ï¼ˆå–å†³äºç›®æ ‡ APIï¼‰

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. `internal/storage/interface.go` - æ•°æ®ç»“æ„å®šä¹‰
2. `internal/storage/sqlite.go` - æ•°æ®åº“æ“ä½œ
3. `internal/storage/stats_adapter.go` - é€‚é…å™¨
4. `internal/transformer/types.go` - Token æå–
5. `internal/proxy/stats.go` - ç»Ÿè®¡è®°å½•
6. `internal/proxy/response.go` - éæµå¼å“åº”
7. `internal/proxy/streaming.go` - æµå¼å“åº”
8. `internal/proxy/proxy.go` - ä¸»å¤„ç†å™¨
9. `internal/service/stats.go` - Service å±‚

**æ€»è®¡ï¼š9 ä¸ªæ ¸å¿ƒæ–‡ä»¶**

---

## âœ¨ å®æ–½å®Œæˆ

æ‰€æœ‰è®¡åˆ’çš„ä¿®æ”¹å·²å®Œæˆï¼ç³»ç»Ÿç°åœ¨æ”¯æŒï¼š
- âœ… ä¸‰åˆ†ç±» cache token ç»Ÿè®¡
- âœ… åŒå±‚ç»Ÿè®¡ï¼ˆæ¯æ—¥èšåˆ + è¯·æ±‚çº§åˆ«ï¼‰
- âœ… è‡ªåŠ¨æ•°æ®åº“è¿ç§»
- âœ… å‘åå…¼å®¹
- âœ… å‡†ç¡®çš„ token æ¶ˆè€—è¿½è¸ª

å¯ä»¥å¼€å§‹ç¼–è¯‘å’Œæµ‹è¯•äº†ï¼
